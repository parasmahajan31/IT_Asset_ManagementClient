@page "/purchase"
@using IT_Asset_ManagementClient.Models
@inject PurchasesService PurchasesService
@inject AssetMasterService AssetService
@inject UserService UserService

<h3>Purchases</h3>
<div class="mb-2"><strong>User:</strong> @currentUser</div>
<div class="mb-3">
    <input class="form-control" placeholder="Search by asset, invoice, or remarks..." @bind="searchText" />
</div>

<h4>Add New Purchase</h4>
<EditForm Model="@newPurchase" OnValidSubmit="AddPurchase">
    <div class="row mb-2">
        <div class="col-md-2">
            <label>Date</label>
            <InputDate class="form-control" @bind-Value="newPurchase.Date" />
        </div>
        <div class="col-md-2">
            <label>Asset</label>
            <InputSelect class="form-control" @bind-Value="newPurchase.AssetId">
                <option value="">Select Asset</option>
                @foreach (var asset in assets)
                {
                    <option value="@asset.Id">@asset.Name</option>
                }
            </InputSelect>
        </div>
        <div class="col-md-2">
            <label>Invoice No</label>
            <InputText class="form-control" @bind-Value="newPurchase.InvoiceNo" />
        </div>
        <div class="col-md-1">
            <label>Qty</label>
            <InputNumber class="form-control" @bind-Value="newPurchase.Quantity" />
        </div>
        <div class="col-md-2">
            <label>Rate</label>
            <InputNumber class="form-control" @bind-Value="newPurchase.Rate" />
        </div>
        <div class="col-md-2 d-flex flex-column justify-content-center">
            <div class="form-check mb-1">
                <InputCheckbox class="form-check-input" @bind-Value="newPurchase.Damaged" id="purchaseDamagedCheck" />
                <label class="form-check-label ms-2" for="purchaseDamagedCheck">Damaged</label>
            </div>
            @if (newPurchase.Damaged)
            {
                <div>
                    <label class="form-label mb-0 mt-1">Damaged Date</label>
                    <InputDate class="form-control" @bind-Value="newPurchase.DamagedDate" />
                </div>
            }
        </div>
        <div class="col-md-2">
            <label>Remarks</label>
            <InputText class="form-control" @bind-Value="newPurchase.Remarks" />
        </div>
    </div>
    <button type="submit" class="btn btn-success">Add Purchase</button>
</EditForm>

<hr />

<h4>All Purchases</h4>
<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Date</th>
            <th>Asset Name</th>
            <th>Invoice No</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>Damaged</th>
            <th>Damaged Date</th>
            <th>Remarks</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in FilteredPurchases)
        {
            <tr>
                <td>@p.Date.ToShortDateString()</td>
                <td>@assets.FirstOrDefault(a => a.Id == p.AssetId)?.Name</td>
                <td>@p.InvoiceNo</td>
                <td>@p.Quantity</td>
                <td>@p.Rate</td>
                <td>@(p.Damaged ? "Yes" : "No")</td>
                <td>@p.DamagedDate?.ToShortDateString()</td>
                <td>@p.Remarks</td>
                <td>
                    <button class="btn btn-danger btn-sm" @onclick="() => DeletePurchase(p)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    string searchText = "";
    List<Purchases> purchases = new();
    List<AssetMaster> assets = new();
    PurchasesCreateDto newPurchase = new() { Date = DateTime.Today };
    string? currentUser;

    IEnumerable<Purchases> FilteredPurchases =>
        string.IsNullOrWhiteSpace(searchText)
            ? purchases
            : purchases.Where(p =>
                (assets.FirstOrDefault(a => a.Id == p.AssetId)?.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || (p.InvoiceNo?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
                || (p.Remarks?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
            );

    protected override async Task OnInitializedAsync()
    {
        currentUser = await UserService.GetUserAsync();
        assets = await AssetService.GetAssetsAsync() ?? new();
        purchases = await PurchasesService.GetPurchasesAsync() ?? new();
    }

    async Task AddPurchase()
    {
        var result = await PurchasesService.CreatePurchaseAsync(newPurchase);
        if (result != null)
        {
            purchases.Add(result);
            newPurchase = new() { Date = DateTime.Today };
        }
    }

    async Task DeletePurchase(Purchases p)
    {
        if (await PurchasesService.DeletePurchaseAsync(p.Id))
        {
            purchases.Remove(p);
        }
    }
}
